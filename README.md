# Cheshire

![alt text](image.png)

Cheshire — ИИ-бот для Telegram, который интегрируется в групповой чат как полноценный участник. Бот анализирует беседу и самостоятельно решает, когда вступить в диалог, а также всегда отвечает на прямые обращения.

## Ключевые особенности

*   **Проактивное участие:** Самостоятельно анализирует диалог и может инициировать ответ.
*   **Реактивные ответы:** Гарантированно отвечает на реплаи и упоминания по `@username`.
*   **Контекстная память:** Хранит историю последних сообщений для релевантных ответов.
*   **Настраиваемые кулдауны:** Гибкая настройка интервалов для контроля частоты ответов и соблюдения лимитов API.
*   **Гибкая настройка личности:** Стиль общения бота полностью определяется редактируемыми системными промптами.

## Установка и запуск

### 1. Клонируйте репозиторий

```bash
git clone https://github.com/your-username/cheshire.git
cd cheshire
```

### 2. Создайте и активируйте виртуальное окружение

```bash
# Windows
python -m venv venv
venv\Scripts\activate

# macOS / Linux
python3 -m venv venv
source venv/bin/activate
```

### 3. Установите зависимости

```bash
pip install -r requirements.txt
```

### 4. Настройте конфигурацию

Создайте файл `config.py` из шаблона `config.example.py` и заполните его своими данными.

```bash
cp config.example.py config.py
```

Откройте `config.py` и заполните следующие поля:

*   `BOT_TOKEN`: Токен вашего Telegram-бота. Получается у **@BotFather** по команде `/newbot`.
*   `OPENAI_API_KEY`: Ключ API от [OpenRouter](https://openrouter.ai/). Создается в личном кабинете в разделе "Keys".
*   `LLM_MODEL_NAME`: Идентификатор модели с OpenRouter (например, `deepseek/deepseek-chat-v3-0324:free`).
*   `TARGET_CHAT_ID`: ID целевого группового чата.
    *   **Способ получения:** Добавьте в чат бота `@getmyid_bot`, он отправит сообщение с `chat.id`. ID групповых чатов обычно начинаются с `-`.
*   `USER_ID_TO_NAME_MAP`: Словарь для сопоставления ID пользователей с их именами.
    *   **Способ получения ID:** Перешлите любое сообщение пользователя боту `@getmyid_bot`. ID будет в поле `from.id`.

### 5. Запустите бота

```bash
python main.py
```

Для остановки используйте `Ctrl+C`.

## Настройка личности бота

Личность и стиль общения бота определяются системным промптом `LEGEND` в файле `src/llm/prompts.py`.

```python
LEGEND = """
# --- Эту часть можно и нужно редактировать (личность бота) ---
Ты — участник дружеского группового чата. Твоя личность: остроумный, дружелюбный и немного саркастичный собеседник.
Твоя задача — проанализировать недавний диалог и решить, стоит ли тебе вмешаться с комментарием.
Не отвечай на каждое сообщение. Вступай в разговор, только если тебе есть что сказать по теме, если ты можешь удачно пошутить или задать интересный вопрос.
"""
PROACTIVE_SYSTEM_PROMPT = """
# --- Эту часть ИЗМЕНЯТЬ НЕЛЬЗЯ (структура ответа) ---
Твой ответ ДОЛЖЕН БЫТЬ в формате JSON объекта со следующими ключами:
- "should_respond": boolean (true, если ты решил ответить; false, если решил промолчать).
- "response_text": string (твой ответ, если should_respond равно true; в противном случае — пустая строка).
"""
```

**ВНИМАНИЕ:** Изменение структуры JSON, названий ключей (`should_respond`, `response_text`) или их формата в `PROACTIVE_SYSTEM_PROMPT` приведет к ошибкам парсинга и неработоспособности бота. Редактируйте только верхнюю, описательную часть.

## План развития

*   **Улучшение истории:** Добавление базы данных. Сохранение сообщений от каждого пользователя отдельно, генерация характеристики пользователя для улучшения качества ответов.
